---
import Phrase from "@/components/audio/phrase.svelte"
import BaseLayout from "@/layouts/base-layout.astro"
import { MarkdownInstance } from "astro"
import path from "node:path"

interface Props {
  note: MarkdownInstance<{
    title: string
    sentence: string
  }>
}

export async function getStaticPaths() {
  const notes = await Astro.glob("@/contents/**/*.mdx")

  return notes.map(note => {
    const filepath = note.file
    const segments = filepath.split("/")
    const rootIdx = segments.findIndex(seg => seg === "contents")
    const slugs = segments
      .slice(rootIdx + 1)
      .map(slug => path.basename(slug, ".mdx"))
    return {
      params: {
        sections:
          slugs[0] === "private" ? slugs.slice(1).join("/") : slugs.join("/"),
      },
      props: { note },
    }
  })
}

const { note } = Astro.props
const { frontmatter, Content } = note
const { sentence } = frontmatter

const phrases = sentence.split("\n").map(str => {
  const _ja = str.match(/<ja>(.*)<\/ja>/)
  const ja = _ja ? _ja[1] : ""
  const en = str.replace(`<ja>${ja}</ja>`, "")
  return { ja, en }
})
---

<BaseLayout frontmatter={frontmatter}>
  {
    phrases.map(({ en, ja }) =>
      en.length > 0 ? <Phrase client:load en={en} ja={ja} /> : <br />,
    )
  }
  <Content />
</BaseLayout>
